{"version":3,"file":"js-data-cloud-datastore.js","sources":["../src/index.js"],"sourcesContent":["// Copyright 2016, Google, Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//   http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n'use strict';\n\nimport {utils} from 'js-data';\nimport Adapter from 'js-data-adapter';\nimport {\n  reserved,\n  Response\n} from 'js-data-adapter';\n\nconst {\n  addHiddenPropsToTarget,\n  classCallCheck,\n  deepMixIn,\n  extend,\n  forEachRelation,\n  forOwn,\n  get,\n  isArray,\n  isObject,\n  isString,\n  isUndefined,\n  omit,\n  plainCopy,\n  resolve,\n  set\n} = utils;\n\nconst withoutRelations = function (mapper, props) {\n  return omit(props, mapper.relationFields || []);\n};\n\nconst equal = function (query, field, value) {\n  return query.filter(field, '=', value);\n};\n\n/**\n * Default predicate functions for the filtering operators.\n *\n * @name CloudDatastoreAdapter.OPERATORS\n * @property {Function} == Equality operator.\n * @property {Function} > \"Greater than\" operator.\n * @property {Function} >= \"Greater than or equal to\" operator.\n * @property {Function} < \"Less than\" operator.\n * @property {Function} <= \"Less than or equal to\" operator.\n */\nconst OPERATORS = {\n  '==': equal,\n  '===': equal,\n  '>': function (query, field, value) {\n    return query.filter(field, '>', value);\n  },\n  '>=': function (query, field, value) {\n    return query.filter(field, '>=', value);\n  },\n  '<': function (query, field, value) {\n    return query.filter(field, '<', value);\n  },\n  '<=': function (query, field, value) {\n    return query.filter(field, '<=', value);\n  }\n};\n\n/**\n * CloudDatastoreAdapter class.\n *\n * @example\n * // Use Container instead of DataStore on the server\n * import {Container} from 'js-data'\n * import CloudDatastoreAdapter from 'js-data-cloud-datastore'\n *\n * // Create a store to hold your Mappers\n * const store = new Container()\n *\n * // Create an instance of CloudDatastoreAdapter with default settings\n * const adapter = new CloudDatastoreAdapter()\n *\n * // Mappers in \"store\" will use the CloudDatastore adapter by default\n * store.registerAdapter('datastore', adapter, { default: true })\n *\n * // Create a Mapper that maps to a \"user\" table\n * store.defineMapper('user')\n *\n * @class CloudDatastoreAdapter\n * @extends Adapter\n * @param {Object} [opts] Configuration opts.\n * @param {string} [opts.basePath=''] TODO\n * @param {boolean} [opts.debug=false] TODO\n */\nexport default function CloudDatastoreAdapter (opts) {\n  const self = this;\n  classCallCheck(self, CloudDatastoreAdapter);\n  opts || (opts = {});\n  Adapter.call(self, opts);\n\n  /**\n   * Override the default predicate functions for specified operators.\n   *\n   * @name CloudDatastoreAdapter#operators\n   * @type {Object}\n   * @default {}\n   */\n  self.operators || (self.operators = {});\n\n  /**\n   * Instance of gcloud used by this adapter.\n   *\n   * @name CloudDatastoreAdapter#gcloud\n   * @type {Object}\n   */\n  self.gcloud = require('gcloud')(opts.gcloud || {\n    projectId: process.env.GCLOUD_PROJECT\n  });\n\n  /**\n   * Instance of gcloud.datastore.dataset used by this adapter.\n   *\n   * @name CloudDatastoreAdapter#dataset\n   * @type {Object}\n   */\n  self.dataset = self.gcloud.datastore.dataset();\n}\n\n// Setup prototype inheritance from Adapter\nCloudDatastoreAdapter.prototype = Object.create(Adapter.prototype, {\n  constructor: {\n    value: CloudDatastoreAdapter,\n    enumerable: false,\n    writable: true,\n    configurable: true\n  }\n});\n\nObject.defineProperty(CloudDatastoreAdapter, '__super__', {\n  configurable: true,\n  value: Adapter\n});\n\n/**\n * Alternative to ES6 class syntax for extending `CloudDatastoreAdapter`.\n *\n * @name CloudDatastoreAdapter.extend\n * @method\n * @param {Object} [instanceProps] Properties that will be added to the\n * prototype of the CloudDatastoreAdapter.\n * @param {Object} [classProps] Properties that will be added as static\n * properties to the CloudDatastoreAdapter itself.\n * @return {Object} CloudDatastoreAdapter of `CloudDatastoreAdapter`.\n */\nCloudDatastoreAdapter.extend = extend;\n\naddHiddenPropsToTarget(CloudDatastoreAdapter.prototype, {\n  /**\n   * Apply the specified selection query to the provided Datastore query.\n   *\n   * @name CloudDatastoreAdapter#filterSequence\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {Object} [query] Selection query.\n   * @param {Object} [query.where] Filtering criteria.\n   * @param {string|Array} [query.orderBy] Sorting criteria.\n   * @param {string|Array} [query.sort] Same as `query.sort`.\n   * @param {number} [query.limit] Limit results.\n   * @param {number} [query.skip] Offset results.\n   * @param {number} [query.offset] Same as `query.skip`.\n   * @param {Object} [opts] Configuration options.\n   * @param {Object} [opts.operators] Override the default predicate functions\n   * for specified operators.\n   */\n  filterQuery (mapper, query, opts) {\n    const self = this;\n    let dsQuery;\n\n    if (opts && opts.query) {\n      dsQuery = opts.query;\n    }\n    query = plainCopy(query || {});\n    opts || (opts = {});\n    opts.operators || (opts.operators = {});\n    query.where || (query.where = {});\n    query.orderBy || (query.orderBy = query.sort);\n    query.orderBy || (query.orderBy = []);\n    query.skip || (query.skip = query.offset);\n\n    // Transform non-keyword properties to \"where\" clause configuration\n    forOwn(query, function (config, keyword) {\n      if (reserved.indexOf(keyword) === -1) {\n        if (isObject(config)) {\n          query.where[keyword] = config;\n        } else {\n          query.where[keyword] = {\n            '==': config\n          };\n        }\n        delete query[keyword];\n      }\n    });\n\n    // Filter\n    if (Object.keys(query.where).length !== 0) {\n      forOwn(query.where, function (criteria, field) {\n        if (!isObject(criteria)) {\n          query.where[field] = {\n            '==': criteria\n          };\n        }\n\n        forOwn(criteria, function (value, operator) {\n          let isOr = false;\n          let _operator = operator;\n          if (_operator && _operator[0] === '|') {\n            _operator = _operator.substr(1);\n            isOr = true;\n          }\n          let predicateFn = self.getOperator(_operator, opts);\n          if (predicateFn) {\n            const predicateResult = predicateFn(dsQuery, field, value);\n            if (isOr) {\n              throw new Error(`Operator ${operator} not supported!`);\n            } else {\n              dsQuery = predicateResult;\n            }\n          } else {\n            throw new Error(`Operator ${operator} not supported!`);\n          }\n        });\n      });\n    }\n\n    if (query.orderBy) {\n      if (isString(query.orderBy)) {\n        query.orderBy = [\n          [query.orderBy, 'asc']\n        ];\n      }\n      query.orderBy.forEach(function (clause) {\n        if (isString(clause)) {\n          clause = [clause, 'asc'];\n        }\n        dsQuery = clause[1].toUpperCase() === 'DESC' ? dsQuery.order(clause[0], { descending: true }) : dsQuery.order(clause[0]);\n      });\n    }\n\n    if (query.skip) {\n      dsQuery = dsQuery.offset(+query.skip);\n    }\n\n    if (query.limit) {\n      dsQuery = dsQuery.limit(+query.limit);\n    }\n\n    return dsQuery;\n  },\n\n  /**\n   * Private method used by create and createMany.\n   * @name CloudDatastoreAdapter#create\n   * @method\n   * @ignore\n   * @param {Object} mapper The mapper.\n   * @param {(Object|Object[])} records The record or records to be created.\n   * @param {Object} [opts] Configuration options.\n   * @return {Promise}\n   */\n  _create (mapper, records, opts) {\n    const self = this;\n    const singular = !isArray(records);\n    if (singular) {\n      records = [records];\n    }\n    return new Promise(function (resolve, reject) {\n      let cursor;\n      const idAttribute = mapper.idAttribute;\n      const incompleteKey = self.dataset.key([mapper.name]);\n\n      // Remove relations\n      records = records.map(function (record) {\n        return withoutRelations(mapper, record);\n      });\n\n      self.dataset.runInTransaction(function (transaction, done) {\n        // Allocate ids\n        transaction.allocateIds(incompleteKey, records.length, function (err, keys) {\n          if (err) {\n            return reject(err);\n          }\n          const entities = records.map(function (_record, i) {\n            set(_record, idAttribute, keys[i].path[1]);\n            return {\n              key: keys[i],\n              data: _record\n            };\n          });\n          // Save records\n          self.dataset.save(entities, function (err, _cursor) {\n            if (err) {\n              return reject(err);\n            }\n            cursor = _cursor;\n            return done();\n          });\n        });\n      }, function (err) {\n        if (err) {\n          return reject(err);\n        }\n        return resolve([cursor, singular ? records[0] : records]);\n      });\n    });\n  },\n\n  /**\n   * Create a new record.\n   *\n   * @name CloudDatastoreAdapter#create\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {Object} props The record to be created.\n   * @param {Object} [opts] Configuration options.\n   * @param {boolean} [opts.raw=false] Whether to return a more detailed\n   * response object.\n   * @return {Promise}\n   */\n  create (mapper, props, opts) {\n    const self = this;\n    let op;\n    props || (props = {});\n    opts || (opts = {});\n\n    // beforeCreate lifecycle hook\n    op = opts.op = 'beforeCreate';\n    return resolve(self[op](mapper, props, opts)).then(function (_props) {\n      // Allow for re-assignment from lifecycle hook\n      props = isUndefined(_props) ? props : _props;\n      return self._create(mapper, props, opts);\n    }).then(function (result) {\n      let [apiResponse, record] = result;\n      let response = new Response(record, apiResponse, 'create');\n      response.created = record ? 1 : 0;\n      response = self.respond(response, opts);\n\n      // afterCreate lifecycle hook\n      op = opts.op = 'afterCreate';\n      return resolve(self[op](mapper, props, opts, response)).then(function (_response) {\n        // Allow for re-assignment from lifecycle hook\n        return isUndefined(_response) ? response : _response;\n      });\n    });\n  },\n\n  /**\n   * Create multiple records in a single batch.\n   *\n   * @name CloudDatastoreAdapter#createMany\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {Array} props Array of records to be created.\n   * @param {Object} [opts] Configuration options.\n   * @param {boolean} [opts.raw=false] Whether to return a more detailed\n   * response object.\n   * @return {Promise}\n   */\n  createMany (mapper, props, opts) {\n    const self = this;\n    let op;\n    props || (props = {});\n    opts || (opts = {});\n\n    // beforeCreateMany lifecycle hook\n    op = opts.op = 'beforeCreateMany';\n    return resolve(self[op](mapper, props, opts)).then(function (_props) {\n      // Allow for re-assignment from lifecycle hook\n      props = isUndefined(_props) ? props : _props;\n      return self._create(mapper, props, opts);\n    }).then(function (result) {\n      let [apiResponse, records] = result;\n      let response = new Response(records, apiResponse, 'createMany');\n      response.created = records.length;\n      response = self.respond(response, opts);\n\n      // afterCreateMany lifecycle hook\n      op = opts.op = 'afterCreateMany';\n      return resolve(self[op](mapper, props, opts, response)).then(function (_response) {\n        // Allow for re-assignment from lifecycle hook\n        return isUndefined(_response) ? response : _response;\n      });\n    });\n  },\n\n  /**\n   * Destroy the record with the given primary key.\n   *\n   * @name CloudDatastoreAdapter#destroy\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {(string|number)} id Primary key of the record to destroy.\n   * @param {Object} [opts] Configuration options.\n   * @param {boolean} [opts.raw=false] Whether to return a more detailed\n   * response object.\n   * @return {Promise}\n   */\n  destroy (mapper, id, opts) {\n    const self = this;\n    let op;\n    opts || (opts = {});\n\n    // beforeDestroy lifecycle hook\n    op = opts.op = 'beforeDestroy';\n    return resolve(self[op](mapper, id, opts)).then(function () {\n      return new Promise(function (resolve, reject) {\n        self.dataset.delete(self.dataset.key([mapper.name, id]), function (err, apiResponse) {\n          return err ? reject(err) : resolve(apiResponse);\n        });\n      });\n    }).then(function (apiResponse) {\n      let response = new Response(undefined, apiResponse, 'destroy');\n      response = self.respond(response, opts);\n\n      // afterDestroy lifecycle hook\n      op = opts.op = 'afterDestroy';\n      return resolve(self[op](mapper, id, opts, response)).then(function (_response) {\n        // Allow for re-assignment from lifecycle hook\n        return isUndefined(_response) ? response : _response;\n      });\n    });\n  },\n\n  /**\n   * Destroy the records that match the selection `query`.\n   *\n   * @name CloudDatastoreAdapter#destroyAll\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {Object} [query] Selection query.\n   * @param {Object} [query.where] Filtering criteria.\n   * @param {string|Array} [query.orderBy] Sorting criteria.\n   * @param {string|Array} [query.sort] Same as `query.sort`.\n   * @param {number} [query.limit] Limit results.\n   * @param {number} [query.skip] Offset results.\n   * @param {number} [query.offset] Same as `query.skip`.\n   * @param {Object} [opts] Configuration options.\n   * @param {Object} [opts.operators] Override the default predicate functions\n   * for specified operators.\n   * @param {boolean} [opts.raw=false] Whether to return a more detailed\n   * response object.\n   * @return {Promise}\n   */\n  destroyAll (mapper, query, opts) {\n    const self = this;\n    const idAttribute = mapper.idAttribute;\n    let op;\n    query || (query = {});\n    opts || (opts = {});\n\n    // beforeDestroyAll lifecycle hook\n    op = opts.op = 'beforeDestroyAll';\n    return resolve(self[op](mapper, query, opts)).then(function () {\n      return self.findAll(mapper, query, { raw: false }).then(function (records) {\n        if (records.length) {\n          return new Promise(function (resolve, reject) {\n            const keys = [];\n            records.forEach(function (record) {\n              const id = get(record, idAttribute);\n              if (!isUndefined(id)) {\n                keys.push(self.dataset.key([mapper.name, id]));\n              }\n            });\n            self.dataset.delete(keys, function (err, apiResponse) {\n              return err ? reject(err) : resolve(apiResponse);\n            });\n          });\n        }\n      });\n    }).then(function (apiResponse) {\n      apiResponse || (apiResponse = {});\n      let response = new Response(undefined, apiResponse, 'destroyAll');\n      response = self.respond(response, opts);\n\n      // afterDestroyAll lifecycle hook\n      op = opts.op = 'afterDestroyAll';\n      return resolve(self[op](mapper, query, opts, response)).then(function (_response) {\n        // Allow for re-assignment from lifecycle hook\n        return isUndefined(_response) ? response : _response;\n      });\n    });\n  },\n\n  /**\n   * Retrieve the record with the given primary key.\n   *\n   * @name CloudDatastoreAdapter#find\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {(string|number)} id Primary key of the record to retrieve.\n   * @param {Object} [opts] Configuration options.\n   * @param {boolean} [opts.raw=false] Whether to return a more detailed\n   * response object.\n   * @param {string[]} [opts.with=[]] Relations to eager load.\n   * @return {Promise}\n   */\n  find (mapper, id, opts) {\n    const self = this;\n    opts || (opts = {});\n    opts.with || (opts.with = []);\n    let op, record;\n    // beforeFind lifecycle hook\n    op = opts.op = 'beforeFind';\n    return resolve(self[op](mapper, id, opts)).then(function () {\n      return new Promise(function (resolve, reject) {\n        const key = self.dataset.key([self.getKind(mapper, opts), id]);\n        self.dataset.get(key, function (err, entity) {\n          if (err) {\n            return reject(err);\n          }\n          return resolve(entity ? entity.data : undefined);\n        });\n      }).then(function (_record) {\n        record = _record;\n        const tasks = [];\n\n        forEachRelation(mapper, opts, function (def, __opts) {\n          let task;\n\n          if (def.foreignKey && (def.type === 'hasOne' || def.type === 'hasMany')) {\n            if (def.type === 'hasOne') {\n              task = self.loadHasOne(mapper, def, record, __opts);\n            } else {\n              task = self.loadHasMany(mapper, def, record, __opts);\n            }\n          } else if (def.type === 'hasMany' && def.localKeys) {\n            throw new Error('find with hasMany & localKeys not supported!');\n          } else if (def.type === 'hasMany' && def.foreignKeys) {\n            throw new Error('find with hasMany & foreignKeys not supported!');\n          } else if (def.type === 'belongsTo') {\n            task = self.loadBelongsTo(mapper, def, record, __opts);\n          }\n\n          if (task) {\n            tasks.push(task);\n          }\n        });\n\n        return Promise.all(tasks);\n      });\n    }).then(function () {\n      let response = new Response(record, {}, 'find');\n      response.found = record ? 1 : 0;\n      response = self.respond(response, opts);\n\n      // afterFind lifecycle hook\n      op = opts.op = 'afterFind';\n      return resolve(self[op](mapper, id, opts, response)).then(function (_response) {\n        // Allow for re-assignment from lifecycle hook\n        return isUndefined(_response) ? response : _response;\n      });\n    });\n  },\n\n  /**\n   * Retrieve the records that match the selection `query`.\n   *\n   * @name CloudDatastoreAdapter#findAll\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {Object} [query] Selection query.\n   * @param {Object} [query.where] Filtering criteria.\n   * @param {string|Array} [query.orderBy] Sorting criteria.\n   * @param {string|Array} [query.sort] Same as `query.sort`.\n   * @param {number} [query.limit] Limit results.\n   * @param {number} [query.skip] Offset results.\n   * @param {number} [query.offset] Same as `query.skip`.\n   * @param {Object} [opts] Configuration options.\n   * @param {boolean} [opts.raw=false] Whether to return a more detailed\n   * response object.\n   * @param {string[]} [opts.with=[]] Relations to eager load.\n   * @return {Promise}\n   */\n  findAll (mapper, query, opts) {\n    const self = this;\n    opts || (opts = {});\n    opts.with || (opts.with = []);\n    let op;\n    let records = [];\n\n    // beforeFindAll lifecycle hook\n    op = opts.op = 'beforeFindAll';\n    return resolve(self[op](mapper, query, opts)).then(function () {\n      return new Promise(function (resolve, reject) {\n        let dsQuery = self.dataset.createQuery(self.getKind(mapper, opts));\n        dsQuery = self.filterQuery(mapper, query, { query: dsQuery });\n        self.dataset.runQuery(dsQuery, function (err, entities) {\n          if (err) {\n            return reject(err);\n          }\n          return resolve(entities ? entities.map(function (entity) {\n            return entity.data;\n          }) : []);\n        });\n      }).then(function (_records) {\n        records = _records;\n        const tasks = [];\n\n        forEachRelation(mapper, opts, function (def, __opts) {\n          let task;\n\n          if (def.foreignKey && (def.type === 'hasOne' || def.type === 'hasMany')) {\n            if (def.type === 'hasMany') {\n              throw new Error('findAll with hasMany not supported!');\n            } else {\n              throw new Error('findAll with hasOne not supported!');\n            }\n          } else if (def.type === 'hasMany' && def.localKeys) {\n            throw new Error('findAll with hasMany & localKeys not supported!');\n          } else if (def.type === 'hasMany' && def.localKeys) {\n            throw new Error('findAll with hasMany & foreignKeys not supported!');\n          } else if (def.type === 'belongsTo') {\n            throw new Error('findAll with belongsTo not supported!');\n          }\n\n          if (task) {\n            tasks.push(task);\n          }\n        });\n        return Promise.all(tasks);\n      });\n    }).then(function () {\n      records || (records = []);\n      let response = new Response(records, {}, 'findAll');\n      response.found = records.length;\n      response = self.respond(response, opts);\n\n      // afterFindAll lifecycle hook\n      op = opts.op = 'afterFindAll';\n      return resolve(self[op](mapper, query, opts, response)).then(function (_response) {\n        // Allow for re-assignment from lifecycle hook\n        return isUndefined(_response) ? response : _response;\n      });\n    });\n  },\n\n  /**\n   * Resolve the Cloud Datastore kind for the specified Mapper with the given\n   * options.\n   *\n   * @name CloudDatastoreAdapter#getKind\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {Object} [opts] Configuration options.\n   * @param {Object} [opts.kind] Datastore kind.\n   * @return {string} The kind.\n   */\n  getKind (mapper, opts) {\n    opts || (opts = {});\n    return isUndefined(opts.kind) ? (isUndefined(mapper.kind) ? mapper.name : mapper.kind) : opts.kind;\n  },\n\n  /**\n   * Resolve the predicate function for the specified operator based on the\n   * given options and this adapter's settings.\n   *\n   * @name CloudDatastoreAdapter#getOperator\n   * @method\n   * @param {string} operator The name of the operator.\n   * @param {Object} [opts] Configuration options.\n   * @param {Object} [opts.operators] Override the default predicate functions\n   * for specified operators.\n   * @return {*} The predicate function for the specified operator.\n   */\n  getOperator (operator, opts) {\n    opts || (opts = {});\n    opts.operators || (opts.operators = {});\n    let ownOps = this.operators || {};\n    return isUndefined(opts.operators[operator]) ? ownOps[operator] || OPERATORS[operator] : opts.operators[operator];\n  },\n\n  _update (mapper, records, props, opts) {\n    const self = this;\n    const singular = !isArray(records);\n    if (singular) {\n      records = [records];\n      props = [props];\n    }\n    return new Promise(function (resolve, reject) {\n      if (!records.length) {\n        return resolve(singular ? undefined : []);\n      }\n      const idAttribute = mapper.idAttribute;\n      const entities = [];\n      const _records = [];\n      records.forEach(function (record, i) {\n        if (!record) {\n          return;\n        }\n        const id = get(record, idAttribute);\n        if (!isUndefined(id)) {\n          deepMixIn(record, props[i]);\n          entities.push({\n            method: 'update',\n            key: self.dataset.key([self.getKind(mapper, opts), id]),\n            data: withoutRelations(mapper, record)\n          });\n          _records.push(record);\n        }\n      });\n      if (!_records.length) {\n        return resolve(singular ? undefined : []);\n      }\n      self.dataset.save(entities, function (err, apiResponse) {\n        if (err) {\n          return reject(err);\n        }\n        return resolve([apiResponse, singular ? _records[0] : _records]);\n      });\n    });\n  },\n\n  /**\n   * Update the records that match the selection `query`. If a record with the\n   * specified primary key cannot be found then no update is performed and the\n   * promise is resolved with `undefined`.\n   *\n   * @name CloudDatastoreAdapter#update\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {(string|number)} id The primary key of the record to be updated.\n   * @param {Object} props The update to apply to the record.\n   * @param {Object} [opts] Configuration options.\n   * @param {boolean} [opts.raw=false] Whether to return a more detailed\n   * response object.\n   * @return {Promise}\n   */\n  update (mapper, id, props, opts) {\n    const self = this;\n    props || (props = {});\n    opts || (opts = {});\n    let op;\n\n    // beforeUpdate lifecycle hook\n    op = opts.op = 'beforeUpdate';\n    return resolve(self[op](mapper, id, props, opts)).then(function (_props) {\n      // Allow for re-assignment from lifecycle hook\n      props = isUndefined(_props) ? props : _props;\n      return self.find(mapper, id, { raw: false }).then(function (record) {\n        if (record) {\n          return self._update(mapper, record, props, opts);\n        } else {\n          throw new Error('Not Found');\n        }\n      });\n    }).then(function (result) {\n      let [apiResponse, record] = result;\n      let response = new Response(record, apiResponse, 'update');\n      response.updated = 1;\n      response = self.respond(response, opts);\n\n      // afterUpdate lifecycle hook\n      op = opts.op = 'afterUpdate';\n      return resolve(self[op](mapper, id, props, opts, response)).then(function (_response) {\n        // Allow for re-assignment from lifecycle hook\n        return isUndefined(_response) ? response : _response;\n      });\n    });\n  },\n\n  /**\n   * Update the records that match the selection `query`.\n   *\n   * @name CloudDatastoreAdapter#updateAll\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {Object} props The update to apply to the selected records.\n   * @param {Object} [query] Selection query.\n   * @param {Object} [query.where] Filtering criteria.\n   * @param {string|Array} [query.orderBy] Sorting criteria.\n   * @param {string|Array} [query.sort] Same as `query.sort`.\n   * @param {number} [query.limit] Limit results.\n   * @param {number} [query.skip] Offset results.\n   * @param {number} [query.offset] Same as `query.skip`.\n   * @param {Object} [opts] Configuration options.\n   * @param {boolean} [opts.raw=false] Whether to return a more detailed\n   * response object.\n   * @return {Promise}\n   */\n  updateAll (mapper, props, query, opts) {\n    const self = this;\n    props || (props = {});\n    query || (query = {});\n    opts || (opts = {});\n    let op;\n\n    // beforeUpdateAll lifecycle hook\n    op = opts.op = 'beforeUpdateAll';\n    return resolve(self[op](mapper, props, query, opts)).then(function (_props) {\n      // Allow for re-assignment from lifecycle hook\n      props = isUndefined(_props) ? props : _props;\n      return self.findAll(mapper, query).then(function (records) {\n        if (records.length) {\n          return self._update(mapper, records, records.map(function () { return props; }), opts);\n        }\n        return [];\n      });\n    }).then(function (result) {\n      let [apiResponse, records] = result;\n      apiResponse || (apiResponse = {});\n      records || (records = []);\n      let response = new Response(records, apiResponse, 'updateAll');\n      response.updated = records.length;\n      response = self.respond(response, opts);\n\n      // afterUpdateAll lifecycle hook\n      op = opts.op = 'afterUpdateAll';\n      return resolve(self[op](mapper, props, query, opts, response)).then(function (_response) {\n        // Allow for re-assignment from lifecycle hook\n        return isUndefined(_response) ? response : _response;\n      });\n    });\n  },\n\n  /**\n   * Update the given records in a single batch.\n   *\n   * @name CloudDatastoreAdapter#updateMany\n   * @method\n   * @param {Object} mapper The mapper.\n   * @param {Object} records The records to update.\n   * @param {Object} [opts] Configuration options.\n   * @param {boolean} [opts.raw=false] Whether to return a more detailed\n   * response object.\n   * @return {Promise}\n   */\n  updateMany (mapper, records, opts) {\n    const self = this;\n    records || (records = []);\n    opts || (opts = {});\n    let op;\n\n    // beforeUpdateMany lifecycle hook\n    op = opts.op = 'beforeUpdateMany';\n    return resolve(self[op](mapper, records, opts)).then(function (_records) {\n      // Allow for re-assignment from lifecycle hook\n      records = isUndefined(_records) ? records : _records;\n      const idAttribute = mapper.idAttribute;\n      _records = records.filter(function (record) {\n        return !isUndefined(get(record, idAttribute));\n      });\n      return Promise.all(_records.map(function (record) {\n        return self.find(mapper, get(record, idAttribute));\n      }));\n    }).then(function (_records) {\n      if (_records.length) {\n        return self._update(mapper, _records, records, opts);\n      }\n      return [];\n    }).then(function (result) {\n      let [apiResponse, _records] = result;\n      apiResponse || (apiResponse = {});\n      _records || (_records = []);\n      let response = new Response(_records, apiResponse, 'updateMany');\n      response.updated = response.data.length;\n      response = self.respond(response, opts);\n\n      // afterUpdateMany lifecycle hook\n      op = opts.op = 'afterUpdateMany';\n      return resolve(self[op](mapper, records, opts, response)).then(function (_response) {\n        // Allow for re-assignment from lifecycle hook\n        return isUndefined(_response) ? response : _response;\n      });\n    });\n  }\n});\n\nCloudDatastoreAdapter.OPERATORS = OPERATORS;\n"],"names":["utils","Adapter","reserved","Response"],"mappings":"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"}